# データベース設計詳細

## ER図（概念図）

```
users (営業担当)
  │
  ├─── customers (顧客)
  │      │
  │      ├─── contacts (連絡履歴)
  │      │
  │      ├─── quotes (見積もり)
  │      │
  │      └─── deals (商談)
  │             │
  │             └─── contracts (契約)
  │
  ├─── notes (メモ)
  │
  └─── sales_targets (営業目標)
```

## テーブル定義

### 1. users (ユーザー・営業担当)

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(100) NOT NULL,
  role VARCHAR(50) NOT NULL DEFAULT 'sales', -- 'admin', 'manager', 'sales'
  avatar_url TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
```

### 2. customers (顧客)

```sql
CREATE TABLE customers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_number VARCHAR(50) UNIQUE, -- 顧客番号
  name VARCHAR(100) NOT NULL,
  name_kana VARCHAR(100),
  email VARCHAR(255),
  phone VARCHAR(20),
  mobile VARCHAR(20),
  postal_code VARCHAR(10),
  address TEXT,
  company_name VARCHAR(200),
  department VARCHAR(100),
  position VARCHAR(100),
  birthdate DATE,
  notes TEXT,
  source VARCHAR(50), -- 'survey', 'phone', 'walk_in', 'referral', 'web'
  assigned_sales_rep_id UUID REFERENCES users(id),
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_customers_name ON customers(name);
CREATE INDEX idx_customers_phone ON customers(phone);
CREATE INDEX idx_customers_assigned_sales ON customers(assigned_sales_rep_id);
CREATE INDEX idx_customers_created_at ON customers(created_at DESC);
```

### 3. contacts (連絡履歴)

```sql
CREATE TABLE contacts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  contact_type VARCHAR(50) NOT NULL, -- 'phone', 'email', 'visit', 'other'
  subject VARCHAR(200),
  content TEXT,
  audio_file_url TEXT, -- 音声ファイルのURL
  memo_file_url TEXT,  -- メモファイルのURL
  next_action TEXT,    -- 次回アクション
  next_contact_date DATE, -- 次回連絡予定日
  contacted_at TIMESTAMP NOT NULL,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_contacts_customer ON contacts(customer_id);
CREATE INDEX idx_contacts_type ON contacts(contact_type);
CREATE INDEX idx_contacts_date ON contacts(contacted_at DESC);
CREATE INDEX idx_contacts_next_date ON contacts(next_contact_date);
```

### 4. quotes (見積もり)

```sql
CREATE TABLE quotes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  quote_number VARCHAR(50) UNIQUE NOT NULL,
  title VARCHAR(200),
  vehicle_model VARCHAR(100), -- 車種
  vehicle_grade VARCHAR(100), -- グレード
  vehicle_color VARCHAR(50),  -- 色
  total_amount DECIMAL(12, 2), -- 総額
  discount_amount DECIMAL(12, 2), -- 値引き額
  final_amount DECIMAL(12, 2), -- 最終金額
  excel_file_url TEXT, -- Excelファイル
  pdf_file_url TEXT,   -- PDF版
  status VARCHAR(50) DEFAULT 'draft', -- 'draft', 'sent', 'approved', 'rejected'
  valid_until DATE,
  sent_at TIMESTAMP,
  approved_at TIMESTAMP,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_quotes_customer ON quotes(customer_id);
CREATE INDEX idx_quotes_number ON quotes(quote_number);
CREATE INDEX idx_quotes_status ON quotes(status);
CREATE INDEX idx_quotes_created_at ON quotes(created_at DESC);
```

### 5. deals (商談・案件)

```sql
CREATE TABLE deals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  stage VARCHAR(50) NOT NULL DEFAULT 'initial_contact',
  -- 'initial_contact', 'hearing', 'quote_sent', 'negotiation',
  -- 'contract', 'awaiting_delivery', 'delivered', 'lost'
  priority VARCHAR(20) DEFAULT 'medium', -- 'low', 'medium', 'high', 'urgent'
  estimated_amount DECIMAL(12, 2),
  probability INTEGER CHECK (probability >= 0 AND probability <= 100),
  expected_close_date DATE,
  lost_reason TEXT,
  assigned_to UUID REFERENCES users(id),
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  closed_at TIMESTAMP
);

CREATE INDEX idx_deals_customer ON deals(customer_id);
CREATE INDEX idx_deals_stage ON deals(stage);
CREATE INDEX idx_deals_assigned_to ON deals(assigned_to);
CREATE INDEX idx_deals_created_at ON deals(created_at DESC);
CREATE INDEX idx_deals_expected_close ON deals(expected_close_date);
```

### 6. contracts (契約)

```sql
CREATE TABLE contracts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  deal_id UUID REFERENCES deals(id) ON DELETE SET NULL,
  customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  contract_number VARCHAR(50) UNIQUE NOT NULL,
  vehicle_model VARCHAR(100) NOT NULL,
  vehicle_grade VARCHAR(100),
  vehicle_color VARCHAR(50),
  vehicle_vin VARCHAR(50), -- 車台番号
  contract_amount DECIMAL(12, 2) NOT NULL, -- 契約金額
  cost_amount DECIMAL(12, 2), -- 原価
  profit_amount DECIMAL(12, 2), -- 利益額
  profit_margin DECIMAL(5, 2), -- 利益率(%)
  contract_date DATE NOT NULL,
  expected_delivery_date DATE,
  actual_delivery_date DATE,
  status VARCHAR(50) DEFAULT 'awaiting_delivery',
  -- 'awaiting_delivery', 'delivered', 'cancelled'
  excel_file_url TEXT, -- 契約書Excel
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_contracts_customer ON contracts(customer_id);
CREATE INDEX idx_contracts_deal ON contracts(deal_id);
CREATE INDEX idx_contracts_number ON contracts(contract_number);
CREATE INDEX idx_contracts_status ON contracts(status);
CREATE INDEX idx_contracts_delivery_date ON contracts(expected_delivery_date);
CREATE INDEX idx_contracts_contract_date ON contracts(contract_date DESC);
```

### 7. sales_targets (営業目標)

```sql
CREATE TABLE sales_targets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  period_type VARCHAR(20) NOT NULL, -- 'monthly', 'quarterly', 'yearly'
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  target_units INTEGER, -- 目標台数
  target_revenue DECIMAL(15, 2), -- 目標売上
  actual_units INTEGER DEFAULT 0, -- 実績台数
  actual_revenue DECIMAL(15, 2) DEFAULT 0, -- 実績売上
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, period_type, period_start)
);

CREATE INDEX idx_targets_user ON sales_targets(user_id);
CREATE INDEX idx_targets_period ON sales_targets(period_start, period_end);
```

### 8. notes (メモ・ノート)

```sql
CREATE TABLE notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  related_type VARCHAR(50) NOT NULL, -- 'customer', 'deal', 'contract', 'general'
  related_id UUID, -- 関連するID
  title VARCHAR(200),
  content JSONB, -- Tiptap JSON形式
  tags TEXT[], -- タグ配列
  is_pinned BOOLEAN DEFAULT false,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notes_related ON notes(related_type, related_id);
CREATE INDEX idx_notes_created_by ON notes(created_by);
CREATE INDEX idx_notes_tags ON notes USING GIN(tags);
CREATE INDEX idx_notes_created_at ON notes(created_at DESC);
```

### 9. scanned_documents (スキャン文書)

```sql
CREATE TABLE scanned_documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,
  document_type VARCHAR(50), -- 'survey', 'phone_memo', 'other'
  original_image_url TEXT NOT NULL,
  ocr_text TEXT,
  ocr_confidence DECIMAL(5, 2), -- OCR信頼度
  is_processed BOOLEAN DEFAULT false,
  is_verified BOOLEAN DEFAULT false, -- 手動確認済み
  uploaded_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_scanned_customer ON scanned_documents(customer_id);
CREATE INDEX idx_scanned_type ON scanned_documents(document_type);
CREATE INDEX idx_scanned_processed ON scanned_documents(is_processed);
```

### 10. email_templates (メールテンプレート)

```sql
CREATE TABLE email_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  subject VARCHAR(200) NOT NULL,
  body_template TEXT NOT NULL,
  category VARCHAR(50), -- 'follow_up', 'quote', 'delivery', 'thank_you'
  is_active BOOLEAN DEFAULT true,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_email_templates_category ON email_templates(category);
```

### 11. email_logs (メール送信履歴)

```sql
CREATE TABLE email_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,
  contact_id UUID REFERENCES contacts(id) ON DELETE SET NULL,
  subject VARCHAR(200) NOT NULL,
  body TEXT NOT NULL,
  sent_to VARCHAR(255) NOT NULL,
  sent_by UUID REFERENCES users(id),
  status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'sent', 'failed'
  error_message TEXT,
  sent_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_email_logs_customer ON email_logs(customer_id);
CREATE INDEX idx_email_logs_status ON email_logs(status);
CREATE INDEX idx_email_logs_sent_at ON email_logs(sent_at DESC);
```

### 12. reminders (リマインダー)

```sql
CREATE TABLE reminders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  related_type VARCHAR(50), -- 'customer', 'deal', 'contract'
  related_id UUID,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  reminder_date TIMESTAMP NOT NULL,
  is_completed BOOLEAN DEFAULT false,
  completed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_reminders_user ON reminders(user_id);
CREATE INDEX idx_reminders_date ON reminders(reminder_date);
CREATE INDEX idx_reminders_completed ON reminders(is_completed);
```

## ビュー（View）

### v_deal_pipeline (パイプライン集計)

```sql
CREATE VIEW v_deal_pipeline AS
SELECT
  stage,
  COUNT(*) as deal_count,
  SUM(estimated_amount) as total_amount,
  AVG(probability) as avg_probability,
  assigned_to
FROM deals
WHERE closed_at IS NULL
GROUP BY stage, assigned_to;
```

### v_monthly_performance (月次実績)

```sql
CREATE VIEW v_monthly_performance AS
SELECT
  DATE_TRUNC('month', contract_date) as month,
  created_by as user_id,
  COUNT(*) as contract_count,
  SUM(contract_amount) as total_revenue,
  SUM(profit_amount) as total_profit,
  AVG(profit_margin) as avg_margin
FROM contracts
WHERE status != 'cancelled'
GROUP BY DATE_TRUNC('month', contract_date), created_by;
```

## トリガー（Trigger）

### 更新日時の自動更新

```sql
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 各テーブルに適用
CREATE TRIGGER update_customers_updated_at
  BEFORE UPDATE ON customers
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at();

-- 他のテーブルにも同様に適用
```

### 契約時の実績更新

```sql
CREATE OR REPLACE FUNCTION update_sales_targets_on_contract()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.status = 'delivered' AND (OLD.status IS NULL OR OLD.status != 'delivered') THEN
    UPDATE sales_targets
    SET
      actual_units = actual_units + 1,
      actual_revenue = actual_revenue + NEW.contract_amount
    WHERE
      user_id = NEW.created_by
      AND period_start <= NEW.contract_date
      AND period_end >= NEW.contract_date;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER contract_update_targets
  AFTER INSERT OR UPDATE ON contracts
  FOR EACH ROW
  EXECUTE FUNCTION update_sales_targets_on_contract();
```

## 初期データ（Seeds）

### ユーザーロール

- admin: 管理者
- manager: マネージャー
- sales: 営業担当

### 商談ステージ

- initial_contact: 初回接触
- hearing: ヒアリング
- quote_sent: 見積もり提示
- negotiation: 商談中
- contract: 契約手続き
- awaiting_delivery: 納車待ち
- delivered: 納車済み
- lost: 失注
